version: '3.8'

services:
  # Redis Cache Service
  redis:
    image: redis:alpine
    container_name: dutchie-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    networks:
      - dutchie-network
    restart: unless-stopped

  # DHT Coordinator Service - Manages unlimited peer network
  dht-coordinator:
    build: .
    container_name: dht-coordinator
    command: python dht_coordinator.py
    ports:
      - "8000:8000"  # API port
      - "9100:9100"  # Peer network port
    volumes:
      - dht_coordinator_storage:/app/cache
    environment:
      - REDIS_URL=${REDIS_URL}
      - MAX_PEERS=${MAX_PEERS}
      - PEER_DISCOVERY_ENABLED=${PEER_DISCOVERY_ENABLED}
      - CACHE_SIZE_GB=${CACHE_SIZE_GB}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DUTCHIE_API_KEY=${DUTCHIE_API_KEY}
      - JANE_API_KEY=${JANE_API_KEY}
    networks:
      - dutchie-network
    depends_on:
      - redis
    restart: unless-stopped

  # DHT Worker 1
  dht-worker-1:
    build: .
    container_name: dht-worker-1
    command: python dht_worker.py
    ports:
      - "9101:9101"  # Peer network port
    volumes:
      - dht_worker1_storage:/app/cache
    environment:
      - REDIS_URL=${REDIS_URL}
      - DHT_COORDINATOR_URL=http://dht-coordinator:8000
      - WORKER_ID=worker-1
    networks:
      - dutchie-network
    depends_on:
      - dht-coordinator
    restart: unless-stopped

  # DHT Worker 2
  dht-worker-2:
    build: .
    container_name: dht-worker-2
    command: python dht_worker.py
    ports:
      - "9102:9102"  # Peer network port
    volumes:
      - dht_worker2_storage:/app/cache
    environment:
      - REDIS_URL=${REDIS_URL}
      - DHT_COORDINATOR_URL=http://dht-coordinator:8000
      - WORKER_ID=worker-2
    networks:
      - dutchie-network
    depends_on:
      - dht-coordinator
    restart: unless-stopped

  # DHT Worker 3
  dht-worker-3:
    build: .
    container_name: dht-worker-3
    command: python dht_worker.py
    ports:
      - "9103:9103"  # Peer network port
    volumes:
      - dht_worker3_storage:/app/cache
    environment:
      - REDIS_URL=${REDIS_URL}
      - DHT_COORDINATOR_URL=http://dht-coordinator:8000
      - WORKER_ID=worker-3
    networks:
      - dutchie-network
    depends_on:
      - dht-coordinator
    restart: unless-stopped

  # DHT Worker 4
  dht-worker-4:
    build: .
    container_name: dht-worker-4
    command: python dht_worker.py
    ports:
      - "9104:9104"  # Peer network port
    volumes:
      - dht_worker4_storage:/app/cache
    environment:
      - REDIS_URL=${REDIS_URL}
      - DHT_COORDINATOR_URL=http://dht-coordinator:8000
      - WORKER_ID=worker-4
    networks:
      - dutchie-network
    depends_on:
      - dht-coordinator
    restart: unless-stopped

networks:
  dutchie-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis-data:
    driver: local
  dht_coordinator_storage:
    driver: local
  dht_worker1_storage:
    driver: local
  dht_worker2_storage:
    driver: local
  dht_worker3_storage:
    driver: local
  dht_worker4_storage:
    driver: local